<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/269392 (zh-CN); Windows/5.1.2600 Service Pack 3;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="11760"/>

<div>
<div><div style="font-size: 16px"><div><div style="background-image:url(http://static.blog.csdn.net/skin/dark1/images/body_bg.jpg);font-size:12px;font-family:Arial, Console, Verdana, 'Courier New';background-position:50% 0%;background-repeat:repeat repeat;"><div><div style="text-align:left;"><div style="overflow:hidden;"><div style="background-color:rgb(255, 255, 255);"><div>
    <div style="display:block;margin:5px 0px;color:rgb(0, 0, 0);font-style:normal;font-variant:normal;font-weight:normal;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';">
    <span style="display:inline-block;width:19px;height:19px;margin:0px 2px 0px 0px;background-image:url(http://static.blog.csdn.net/images/ico_Repost.gif);vertical-align:middle;background-position:0px 0px;background-repeat:no-repeat no-repeat;"></span>
    <h3 style="margin:0px;padding:0px;display:inline;font-style:normal;font-variant:normal;font-weight:normal;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';vertical-align:middle;">
        <span><a href="http://blog.csdn.net/yinwei520/article/details/6646933" shape="rect" style="color:rgb(0, 0, 0);text-decoration:none;">
        Linux中__init、__devinit等初始化宏
        </a></span>
    </h3>
<span style="color:rgb(0, 0, 0);font-style:normal;font-variant:normal;font-weight:normal;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';display:block;height:0px;clear:both;visibility:hidden;">.</span></div>

        
    <div style="padding:5px 0px;color:rgb(153, 153, 153);font-style:normal;font-variant:normal;font-weight:normal;font-size:12px;line-height:24px;font-family:Arial;text-align:right;">
        <span style="margin:0px 5px;float:left;">
        分类：
            <a href="http://blog.csdn.net/yinwei520/article/category/717900" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;">Linux操作系统</a> 
        </span>
    <span style="margin:0px 5px 0px 0px;">2011-07-30 17:22</span>
    <span style="margin:0px 5px;padding:0px 0px 0px 14px;background-image:url(http://static.blog.csdn.net/images/ico_view.png);background-position:0% 50%;background-repeat:no-repeat no-repeat;" title="阅读次数">1564人阅读</span>
    <span style="margin:0px 5px;padding:0px 0px 0px 14px;background-image:url(http://static.blog.csdn.net/images/ico_comm.png);background-position:0% 50%;background-repeat:no-repeat no-repeat;" title="评论次数"><a href="http://blog.csdn.net/yinwei520/article/details/6646933#comments" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;">评论</a>(1)</span>
    <span style="margin:0px 5px;"><a href="#" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;" title="收藏">收藏</a></span>
    <span style="margin:0px 5px;"><a href="http://blog.csdn.net/yinwei520/article/details/6646933#report" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;" title="举报">举报</a></span>
    
</div>
<div style="margin:10px 0px;"><a href="http://blog.csdn.net/tag/details.html?tag=linux" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;display:inline-block;padding:4px 10px;line-height:100%;margin-right:10px;border:1px solid rgb(238, 238, 238);background-color:rgb(238, 238, 238);border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;" target="_blank">linux</a><a href="http://blog.csdn.net/tag/details.html?tag=%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;display:inline-block;padding:4px 10px;line-height:100%;margin-right:10px;border:1px solid rgb(238, 238, 238);background-color:rgb(238, 238, 238);border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;" target="_blank">数据结构</a><a href="http://blog.csdn.net/tag/details.html?tag=module" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;display:inline-block;padding:4px 10px;line-height:100%;margin-right:10px;border:1px solid rgb(238, 238, 238);background-color:rgb(238, 238, 238);border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;" target="_blank">module</a><a href="http://blog.csdn.net/tag/details.html?tag=%e4%bc%98%e5%8c%96" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;display:inline-block;padding:4px 10px;line-height:100%;margin-right:10px;border:1px solid rgb(238, 238, 238);background-color:rgb(238, 238, 238);border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;" target="_blank">优化</a><a href="http://blog.csdn.net/tag/details.html?tag=%e7%bc%96%e8%af%91%e5%99%a8" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;display:inline-block;padding:4px 10px;line-height:100%;margin-right:10px;border:1px solid rgb(238, 238, 238);background-color:rgb(238, 238, 238);border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;" target="_blank">编译器</a><a href="http://blog.csdn.net/tag/details.html?tag=c" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;display:inline-block;padding:4px 10px;line-height:100%;margin-right:10px;border:1px solid rgb(238, 238, 238);background-color:rgb(238, 238, 238);border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;" target="_blank">c</a></div>


    
<div style="margin:20px 0px 0px;font-style:normal;font-variant:normal;font-weight:normal;font-size:14px;line-height:26px;font-family:Arial;">

 
<p style="margin:0px;padding:0px;margin-left:15pt;margin-right:15pt;">内核使用了大量不同的宏来标记具有不同作用的函数和数据结构。如宏<span lang="EN">__init</span> 、<span lang="EN">__devinit</span> 等。这些宏在<span lang="EN">include/linux/init.h</span> 头文件中定义。编译器通过这些宏可以把代码优化放到合适的内存位置，以减少内存占用和提高内核效率。</p>
<p style="margin:0px;padding:0px;margin-left:15pt;margin-right:15pt;">下面是一些常用的宏：</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">__init</span> ，标记内核启动时使用的初始化代码，内核启动完成后不再需要。以此标记的代码位于<span lang="EN">.init.text</span> 内存区域。它的宏定义是这样的：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt 51pt;text-indent:-18pt;"><span style="font-family:Symbol;">·<span style="font:7pt 'Times New Roman';"> </span> </span> <span lang="EN">#define _ _init _ _attribute_ _ ((_ _section_ _ (&quot;.text.init&quot;)))</span> 
 </pre>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">__exit</span> ，标记退出代码，对于非模块无效。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">__initdata</span> ，标记内核启动时使用的初始化数据结构，内核启动完成后不再需要。以此标记的代码位于<span lang="EN">.init.data</span> 内存区域。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">__devinit</span> ，标记设备初始化使用的代码。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">__devinitdata</span> ，标记初始化设备数据结构的函数。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">__devexit</span> ，标记移除设备时使用的代码。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">xxx_initcall</span> ，一系列的初始化代码，按降序优先级排列。</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> </span>初始化代码的内存结构
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> </span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> </span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN">_init_begin -------------------</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .init.text | ---- __init</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .init.data | ---- __initdata</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN">_setup_start |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .init.setup | ---- __setup_param</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN">__initcall_start |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall1.init | ---- core_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall2.init | ---- postcore_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall3.init | ---- arch_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall4.init | ---- subsys_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall5.init | ---- fs_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall6.init | ---- device_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | .initcall7.init | ---- late_initcall</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN">__initcall_end |-------------------|</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | |</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | ... ... ... |</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN"> | |</span> 
 </pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;background:#e8e8e8;margin:0cm 15pt 0pt;"><span lang="EN">__init_end -------------------</span> 
 </pre>
<p style="margin:0px;padding:0px;margin-left:15pt;margin-right:15pt;">初始化代码的特点是：在系统启动运行，且一旦运行后马上退出内存，不再占用内存。</p>
<p style="margin:0px;padding:0px;margin-left:15pt;margin-right:15pt;">对于驱动程序模块来说，这些优化标记使用的情况如下：</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span>通过<span lang="EN">module_init()</span> 和<span lang="EN">module_exit()</span> 函数调用的函数就需要使用<span lang="EN">__init</span> 和<span lang="EN">__exit</span> 宏来标记。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">pci_driver</span> 数据结构不需标记。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span><span lang="EN">probe()</span> 和<span lang="EN">remove()</span> 函数应该使用<span lang="EN">__devinit</span> 和<span lang="EN">__devexit</span> 标记，且只能标记<span lang="EN">probe()</span> 和<span lang="EN">remove()</span>
</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span>如果<span lang="EN">remove()</span> 使用<span lang="EN">__devexit</span> 标记，则在<span lang="EN">pci_driver</span> 结构中要用<span lang="EN">__devexit_p(remove)</span> 来引用<span lang="EN">remove()</span> 函数。</p>
<p style="margin:0px;padding:0px;margin-left:51pt;text-indent:-18pt;margin-right:15pt;"><span style="font-family:Symbol;font-size:10pt;">·<span style="font:7pt 'Times New Roman';">  </span>
</span>如果你不确定需不需要添加优化宏则不要添加。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span style="color:#ff0000;">补充：例如，如果要在驱动中使用i2c或者spi总线，那么他们的初始化常常会被赋值为subsys_initcall()等</span></p>

</div>

<div style="float:right;width:170px;margin:5px 0px;font-style:normal;font-variant:normal;font-weight:normal;font-size:12px;line-height:24px;font-family:Arial, Helvetica, sans-serif;text-align:right;"><span style="display:inline-block;line-height:30px;font-weight:bold;color:green;vertical-align:middle;">分享到：</span> <a name="sina" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;background-image:url(http://static.blog.csdn.net/images/ico_sina.gif);background-position:0px 5px;background-repeat:no-repeat no-repeat;display:inline-block;width:25px;height:30px;cursor:pointer;vertical-align:middle;" title="分享到新浪微博"></a><a name="qq" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;background-image:url(http://static.blog.csdn.net/images/ico_qq.gif);background-position:0px 5px;background-repeat:no-repeat no-repeat;display:inline-block;width:25px;height:30px;cursor:pointer;vertical-align:middle;" title="分享到腾讯微博"></a></div>

<div style="margin-top:30px;display:block;color:rgb(102, 102, 102);font-style:normal;font-variant:normal;font-weight:normal;font-size:12px;line-height:24px;font-family:Arial, Helvetica, sans-serif;">
    <ul><li style="list-style-type:none;"><span>上一篇：</span><a href="http://blog.csdn.net/yinwei520/article/details/6646091" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;">NDK+Cygwin环境搭建</a></li><li style="list-style-type:none;"><span>下一篇：</span><a href="http://blog.csdn.net/yinwei520/article/details/6652941" shape="rect" style="color:rgb(202, 0, 0);text-decoration:none;">linux中input_register_device注册函数分析</a></li></ul><span style="color:rgb(102, 102, 102);font-style:normal;font-variant:normal;font-weight:normal;font-size:12px;line-height:24px;font-family:Arial, Helvetica, sans-serif;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>


    
</div></div></div></div></div></div></div></div></div>
</div></body></html> 