<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0067)http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786943 -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=GBK">

<meta name="description" content="">
<meta name="keywords" content="">
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
<title> hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活</title>

<script type="text/javascript" async="" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/ga.js"></script><script language="javascript" type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/script_cookie.js"></script>
<script language="javascript" type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/script_common.js"></script>
<script language="javascript" type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/script_menu.js"></script>
<script language="javascript" type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/script_ajax.js"></script>
<script language="javascript" type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/script_face.js"></script>
<script language="javascript" type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/script_manage.js"></script>
<link rel="StyleSheet" href="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/style.css" type="text/css" media="screen">
<link rel="StyleSheet" href="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/default.css" type="text/css" media="screen">
</head>
<body><link href="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/jiathis_share.css" rel="stylesheet" type="text/css"><iframe style="position: absolute; opacity: 0; display: none; " frameborder="0"></iframe><div id="ckepop" style="position: absolute; z-index: 1000000000; top: 50%; left: 50%; overflow-x: auto; overflow-y: auto; display: none; "></div><div id="ckepop" style="position: absolute; z-index: 1000000000; display: none; overflow-x: auto; overflow-y: auto; "></div><iframe style="display: none; " frameborder="0" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/jiathis_utility.htm"></iframe>

<style type="text/css">
@import url(http://blog.chinaunix.net/css/nav.css);
</style>

<div class="login">
<div class="Content">
<div class="l1" id="ll">

<a href="http://www.chinaunix.net/" target="_blank">CU首页</a>
<a href="http://blog.chinaunix.net/link.php?url=http://bbs.chinaunix.net" title="CU论坛" target="_blank">CU论坛首页</a>
<a href="http://blog.chinaunix.net/link.php?url=http://blog.chinaunix.net" title="CU博客" target="_blank">CU博客首页</a>   ┊ 
<a href="http://blog.chinaunix.net/do.php?ac=819edd0a745efc58097086a9ef2fc155">登录</a>
<a href="http://blog.chinaunix.net/do.php?ac=8f442ba1e0c79cd3efcd1fd42b8aad8e">注册</a>
   ┊    
<a href="http://blog.chinaunix.net/network.php">随便看看</a>
</div>
<div class="r1">
<form action="http://blog.chinaunix.net/cp.php" method="get">
    <input type="hidden" name="ac" id="ac" value="search">
<input type="submit" class="btn1" style="margin-bottom:0px;" value="">
<select name="searchType" id="searchType" style="line-height: 13px;margin-bottom:0px;padding:0px;height:21px;">
<option value="blog">博文</option>
<option value="friend">博主</option>
<option value="album">相册</option>
<option value="poll">投票</option>
<option value="event">活动</option>
</select>
<input type="hidden" value="hbhuanggang" name="username">
<input type="text" class="inp1" name="searchkey" id="searchkey" style="margin-bottom:0px;">
<a href="http://blog.chinaunix.net/cp.php?ac=blog" class="a1">发博文</a>
</form>
</div>
</div>
</div>

<ul id="ucappmenu_menu" class="dropmenu_drop" style="display:none;">
<li><a href="http://blog.chinaunix.net/link.php?url=http://bbs.chinaunix.net" title="CU论坛" target="_blank">CU论坛首页</a></li>
<li><a href="http://blog.chinaunix.net/link.php?url=http://blog.chinaunix.net" title="CU博客" target="_blank">CU博客首页</a></li>
</ul>


<div id="append_parent" style="z-index:99999;"></div>
<div id="ajaxwaitid"></div>
<span id="pageSet"></span>
<div class="Content" id="Content">
<div class="top" id="top" style=" position:relative;">
    <div class="tm"><a href="http://blog.chinaunix.net/link.php?url=http%3A%2F%2Fblog.chinaunix.net%2Fspace.php%3Fuid%3D26299858%26do%3Dblog%26id%3D2977055%26stats%3Dclick" target="_blank">公告：缅怀Dennis Ritchie活动开赛啦！</a></div>
<div class="addr">
       			<b id="home_title">hbhuanggang</b>
   	 <p>
<a href="http://blog.chinaunix.net/space.php?uid=22174347">http://blog.chinaunix.net/space.php?uid=22174347</a>
</p>
<span id="blog_brief">
<span id="blog_b"></span>&nbsp;&nbsp;&nbsp;
</span>
<div id="blog_brief_form" style="display:none; height:auto;">
 		<form id="brief_form" method="post" action="http://blog.chinaunix.net/do.php?ac=ajax&op=blog_brief">
              			<input type="text" id="blog_brief" name="blog_brief" value="" size="50" style="margin-bottom:0px;">
             			<input type="button" onclick="checkBbrief();" value="提交" class="submit" style="height:20px;margin-bottom:0px;">&nbsp;
            			<input type="hidden" name="formhash" value="3190e1cf">
              			<input type="button" value="取消" class="submit" style="height:20px;margin-bottom:0px;" onclick="s(&#39;blog_brief&#39;);h(&#39;blog_brief_form&#39;);">
             		 </form>
</div>
              
</div>
<div class="daoh">
<a href="http://blog.chinaunix.net/space.php?uid=22174347">首页</a> | 
<a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&view=me&frmd=-1" class="here" ;="">博文目录</a>  |  
<a href="http://blog.chinaunix.net/space.php?do=album&view=me&uid=22174347">相册</a>  |  
<a href="http://blog.chinaunix.net/group.php" target="_blank">博客圈</a>  |
<a href="http://blog.chinaunix.net/space.php?do=profile&uid=22174347">关于我</a>  |
<a href="http://blog.chinaunix.net/space.php?do=profile&uid=22174347#comment">留言</a>
</div>
</div>
<link href="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/fck_editorarea.css" rel="stylesheet" type="text/css">
<div class="l2 ">	
<!-- 个人资料 -->
<div class="bor1 mt10" id="profile">
<div class="tit1">个人资料</div>
<div class="Img"><a href="http://blog.chinaunix.net/space.php?uid=22174347"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/noavatar_big.gif" onerror="this.onerror=null;this.src=&#39;http://bbs.chinaunix.net/uc_server/images/noavatar_big.gif&#39;"></a></div>
<div class="Text">
<div class="p1">
<a href="http://blog.chinaunix.net/space.php?uid=22174347">hbhuanggang</a>
   		   		</div>
<div class="p3" style="height:38px;">
 <a href="http://blog.chinaunix.net/space.php?do=doing&view=me&uid=22174347" target="_blank">微博</a>
 <a href="http://blog.chinaunix.net/link.php?url=http://bbs.chinaunix.net%2F" target="_blank">论坛</a>
</div>
<div class="p3"> 
 <a href="http://blog.chinaunix.net/cp.php?ac=pm&uid=22174347" id="a_pm" onclick="ajaxmenu(event, this.id, 1)">发纸条</a> 
 <a href="http://blog.chinaunix.net/cp.php?ac=poke&op=send&uid=22174347" id="a_poke" onclick="ajaxmenu(event, this.id, 1)">打招呼</a>
 <span id="attention"><a href="javascript:;" onclick="attention(22174347 , &#39;add&#39;);">加关注</a></span>
   <a href="http://blog.chinaunix.net/cp.php?ac=friend&op=add&uid=22174347" id="a_friend_li" onclick="ajaxmenu(event, this.id, 1)">加好友</a>
 </div>

<div class="list1">
<ul>
<li>博客访问：441799</li>
<li>博文数量：55</li>
<li>博客积分：6031</li>
<li>博客等级：<a href="http://blog.chinaunix.net/cp.php?ac=credit&op=usergroup">准将</a> </li>
<li>关注人气： 8</li>
<li>注册时间：2009-07-23 10:09:46</li>
</ul>
</div>
</div>
</div>

<!-- 文章分类 -->
<div class="bor1 mt10" id="blist">
<div class="tit1">文章分类</div>
<div class="allla">
<div class="alll"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&view=me&frmd=-1">全部博文<b>(55)</b></a></div>
<div class="alll1"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/list41.gif" id="79951" onclick="opDIV(this.id);" style="cursor:pointer;"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79951&view=me" title="嵌入式Linux+ARM">嵌入式Linux+ARM(53)</a></div>
<div style="display:none;" id="DIV_79951" class="alll3">
<div class="alll4"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/list3.gif"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79956&view=me&fup=79951" title="嵌入式Linux+ARM">其他电子通讯技术篇(2)</a></div>
<div class="alll4"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/list3.gif"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79952&view=me&fup=79951" title="嵌入式Linux+ARM">内核、驱动开发篇(24)</a></div>
<div class="alll4"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/list3.gif"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79954&view=me&fup=79951" title="嵌入式Linux+ARM">内核、文件系统、应用移植开发篇(12)</a></div>
<div class="alll4"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/list3.gif"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79955&view=me&fup=79951" title="嵌入式Linux+ARM">Bootloader移植篇(6)</a></div>
<div class="alll4"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/list3.gif"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79953&view=me&fup=79951" title="嵌入式Linux+ARM">基础篇(4)</a></div>
</div>
<div class="alll"><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&view=me&frmd=0">未分类博文(2)</a></div>
</div>
</div>
<script>
function opDIV(id){
if(document.getElementById('DIV_'+id).style.display=='none'){
document.getElementById('DIV_'+id).style.display='block';
document.getElementById(id).src="image/list4.gif";
}else{
document.getElementById('DIV_'+id).style.display='none';
document.getElementById(id).src="image/list41.gif";
}
}
</script>


<!-- 订阅我的博客 -->
<div class="bor1 mt10" id="rss">
<div class="tit1">订阅我的博客</div>
<ul class="list3">
<li><a href="http://blog.chinaunix.net/rss.php?uid=22174347"><img alt="订阅" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/feedsky.gif" width="49" height="16"></a></li>
<li><a target="_blank" href="http://www.xianguo.com/subscribe.php?url=http://home.chinaunix.com/rss.php?uid=22174347"><img border="0" alt="订阅到鲜果" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/d2.png"></a></li>
<li><a target="_blank" href="http://www.zhuaxia.com/add_channel.php?url=http://home.chinaunix.com/rss.php?uid=22174347"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/d3.png" width="103" height="16" border="0" alt="订阅到抓虾"></a></li>
<li><a target="_blank" href="http://fusion.google.com/add?feedurl=http://home.chinaunix.com/rss.php?uid=22174347"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/d4.png" width="103" height="16" border="0" alt="订阅到Google"></a></li>
</ul>
</div>


<!-- 好友 -->

<!-- 最近来访 -->
</div>
<div class="r2" id="blog_center">
<!-- 博文 -->
<div class="bor1 mt10">
<div class="tit5"><span>字体大小：<a href="javascript:;" onclick="doZoom(&#39;16&#39;);" id="font_16">大</a> <a href="javascript:;" onclick="doZoom(&#39;14&#39;);" id="font_14" style="font-weight: bold; ">中</a> <a href="javascript:;" onclick="doZoom(&#39;12&#39;);" id="font_12">小</a></span>博文</div>
<div class="text">
<div class="tit6">
<a href="javascript:;">嵌入式Linux之我行――S3C2440上LCD驱动(FrameBuffer)实例开发讲解（二）</a> 
(2010-04-06 21:56)
</div>
<div class="tit7">
分类： <a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&frmd=79951&classid=79952&view=me">内核、驱动开发篇</a>
</div>
<div id="detail" class="detail" style="line-height: 1.3;"><p></p><div>嵌入式Linux之我行，主要讲述和总结了本人在学习嵌入式linux中的每个步骤。一为总结经验，二希望能给想入门嵌入式Linux的朋友提供方便。如有错误之处，谢请指正。</div>
<ul>
<li><font size="2"><font face="楷体">共享资源</font>，欢迎转载：</font><a href="http://blog.chinaunix.net/link.php?url=http://hbhuanggang.cublog.cn%2F"><font color="#0000ff" size="2">http://hbhuanggang.cublog.cn</font></a> </li></ul>
<p><strong><font size="3">&nbsp;&nbsp; 开发环境</font></strong></p>
<ul>
<li><font size="2">主 &nbsp;机：VMWare--Fedora 9</font> 
</li><li><font size="2">开发板：Mini2440--64MB Nand, Kernel:2.6.30.4</font> 
</li><li><font size="2">编译器：arm-linux-gcc-4.3.2</font></li></ul>
<p><font face="宋体" color="#ff0000"><strong>上接：</strong></font><a href="http://blog.chinaunix.net/link.php?url=http://blog.chinaunix.net%2Fu3%2F101649%2Fshowart_2188364.html" target="_blank"><font face="宋体" color="#ff0000"><strong>S3C2440上LCD驱动(FrameBuffer)实例开发详解（一）</strong></font></a></p>
<p><strong><font face="宋体" size="3">四、帧缓冲(FrameBuffer)设备驱动实例代码：</font></strong></p>
<div><font face="宋体" size="2"><strong>①、建立驱动文件：my2440_lcd.c，依就是驱动程序的最基本结构：<font face="Courier New">FrameBuffer</font>驱动的初始化和卸载部分及其他，如下：</strong></font></div>
<table style="BORDER-COLLAPSE: collapse" bordercolor="#999999" cellspacing="0" cellpadding="0" width="95%" bgcolor="#f1f1f1" border="1">
<tbody>
<tr>
<td><code><span style="COLOR: #000000"><span style="COLOR: #0000cc">
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><font face="NSimsun"><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>kernel<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>module<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span><span style="COLOR: #ff0000">errno</span><span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>init<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>platform_device<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>dma<span style="COLOR: #0000cc">-</span>mapping<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>fb<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>clk<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>interrupt<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>mm<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span></font></span></code></p>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><font face="NSimsun"><span style="COLOR: #0000cc"></span><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/slab</span><span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span><font color="#0000cc">delay</font><span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span><span style="COLOR: #0000ff">asm</span><span style="COLOR: #0000cc">/</span>irq<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span><span style="COLOR: #0000ff">asm</span><span style="COLOR: #0000cc">/</span>io<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span><span style="COLOR: #0000ff">asm</span><span style="COLOR: #0000cc">/</span>div64<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>mach<span style="COLOR: #0000cc">/</span>regs<span style="COLOR: #0000cc">-</span>lcd<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>mach<span style="COLOR: #0000cc">/</span>regs<span style="COLOR: #0000cc">-</span>gpio<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>mach<span style="COLOR: #0000cc">/</span>fb<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">include</span> <span style="COLOR: #0000cc">&lt;</span>linux<span style="COLOR: #0000cc">/</span>pm<span style="COLOR: #0000cc">.</span>h<span style="COLOR: #0000cc">&gt;</span></font></span></code></p><code><span style="COLOR: #000000"><font face="NSimsun"><span style="COLOR: #0000cc"></span></font></span></code></span>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><br><font face="宋体"><span style="COLOR: #ff9900">/*FrameBuffer设备名称*/</span><br><span style="COLOR: #0000cc"><font color="#000000"><span style="COLOR: #0000ff">static char</span>&nbsp;driver_name[] = <font color="#0000ff">"</font><font color="#ff0000">my2440_lcd</font><font color="#0000ff">"</font>;</font></span><span style="COLOR: #ff00ff"></span><br><br></font><font face="宋体"><span style="COLOR: #ff9900">/*定义一个结构体用来维护驱动程序中各函数中用到的变量<br>&nbsp;&nbsp;先别看结构体要定义这些成员，到各函数使用的地方就明白了*/</span><br><span style="COLOR: #0000ff">struct</span> my2440fb_var<br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> lcd_irq_no<span style="COLOR: #0000cc">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #ff9900">/*保存LCD中断号*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> clk <span style="COLOR: #0000cc">*</span>lcd_clock<span style="COLOR: #0000cc">;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*保存从平台时钟队列中获取的LCD时钟*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> resource <span style="COLOR: #0000cc">*</span>lcd_mem<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*LCD的IO空间*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>lcd_base<span style="COLOR: #0000cc">;</span>&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*LCD的IO空间映射到虚拟地址*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> device <span style="COLOR: #0000cc">*</span>dev<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_hw&nbsp;regs<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*表示5个LCD配置寄存器，s3c2410fb_hw定义在mach-s3c2410/include/mach/fb.h中*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*定义一个数组来充当调色板。<br>&nbsp;&nbsp;&nbsp;&nbsp;据数据手册描述，TFT屏色位模式为8BPP时，调色板(颜色表)的长度为256，调色板起始地址为0x4D000400*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;u32&nbsp;&nbsp;&nbsp;&nbsp;palette_buffer<span style="COLOR: #0000cc">[</span>256<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">;</span>&nbsp;</font></p>
</span></code><p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><font face="宋体">&nbsp;&nbsp;&nbsp;&nbsp;u32&nbsp;pseudo_pal[16];&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> palette_ready<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*标识调色板是否准备好了*/</span><br><span style="COLOR: #0000cc">}</span><span style="COLOR: #0000cc">;</span><br><br><span style="COLOR: #ff9900">/*用做清空调色板(颜色表)*/</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">define</span> PALETTE_BUFF_CLEAR <span style="COLOR: #0000cc">(</span>0x80000000<span style="COLOR: #0000cc">)</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><br><span style="COLOR: #ff9900">/*LCD平台驱动结构体，平台驱动结构体定义在platform_device.h中，该结构体成员接口函数在第②步中实现*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">struct</span> platform_driver lcd_fb_driver <span style="COLOR: #0000cc">=</span> <br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>probe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> lcd_fb_probe<span style="COLOR: #0000cc">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #ff9900">/*FrameBuffer设备探测*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span><span style="COLOR: #ff0000">remove</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> __devexit_p<span style="COLOR: #0000cc">(</span>lcd_fb_remove<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">,</span>&nbsp;<span style="COLOR: #ff9900">/*FrameBuffer设备移除*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>suspend&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> lcd_fb_suspend<span style="COLOR: #0000cc">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #ff9900">/*FrameBuffer设备挂起*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>resume&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> lcd_fb_resume<span style="COLOR: #0000cc">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*FrameBuffer设备恢复*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>driver&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*注意这里的名称一定要和系统中定义平台设备的地方一致，这样才能把平台设备与该平台设备的驱动关联起来*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>name&nbsp;<span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff00ff">"s3c2410-lcd"</span><span style="COLOR: #0000cc">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>owner&nbsp;<span style="COLOR: #0000cc">=</span> THIS_MODULE<span style="COLOR: #0000cc">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><span style="COLOR: #0000cc">,</span><br><span style="COLOR: #0000cc">}</span><span style="COLOR: #0000cc">;</span><br><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> __init lcd_init<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">void</span><span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*在Linux中，帧缓冲设备被看做是平台设备，所以这里注册平台设备*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> platform_driver_register<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>lcd_fb_driver<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> __exit lcd_exit<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">void</span><span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*注销平台设备*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;platform_driver_unregister<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>lcd_fb_driver<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br>module_init<span style="COLOR: #0000cc">(</span>lcd_init<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>module_exit<span style="COLOR: #0000cc">(</span>lcd_exit<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>MODULE_LICENSE<span style="COLOR: #0000cc">(</span><span style="COLOR: #ff00ff">"GPL"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>MODULE_AUTHOR<span style="COLOR: #0000cc">(</span><span style="COLOR: #ff00ff">"Huang Gang"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>MODULE_DESCRIPTION<span style="COLOR: #0000cc">(</span><span style="COLOR: #ff00ff">"My2440 LCD FrameBuffer Driver"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span></font></code></p></td></tr></tbody></table><br>
<div><strong><font face="宋体" size="2">②、LCD平台设备各接口函数的实现：</font></strong></div>
<table style="BORDER-COLLAPSE: collapse" bordercolor="#999999" cellspacing="0" cellpadding="0" width="95%" bgcolor="#f1f1f1" border="1">
<tbody>
<tr>
<td>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><font face="宋体"><span style="COLOR: #ff9900">/*LCD FrameBuffer设备探测的实现，注意这里使用一个__devinit宏，到lcd_fb_remove接口函数实现的地方讲解*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> __devinit lcd_fb_probe<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> platform_device <span style="COLOR: #0000cc">*</span>pdev<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> i<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> ret<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> resource&nbsp;<span style="COLOR: #0000cc">*</span>res<span style="COLOR: #0000cc">;</span>&nbsp;&nbsp;<span style="COLOR: #ff9900">/*用来保存从LCD平台设备中获取的LCD资源*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_info&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*FrameBuffer驱动所对应的fb_info结构体*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_mach_info&nbsp;<span style="COLOR: #0000cc">*</span>mach_info<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*保存从内核中获取的平台设备数据*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;<span style="COLOR: #0000cc">*</span>fbvar<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*上面定义的驱动程序全局变量结构体*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_display&nbsp;<span style="COLOR: #0000cc">*</span>display<span style="COLOR: #0000cc">;</span>&nbsp;<span style="COLOR: #ff9900">/*LCD屏的配置信息结构体，该结构体定义在mach-s3c2410/include/mach/fb.h中*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*获取LCD硬件相关信息数据，在前面讲过内核使用s3c24xx_fb_set_platdata函数将LCD的硬件相关信息保存到<br>&nbsp;&nbsp;&nbsp;&nbsp; 了LCD平台数据中，所以这里我们就从平台数据中取出来在驱动中使用*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;mach_info <span style="COLOR: #0000cc">=</span> pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">.</span>platform_data<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>mach_info <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断获取数据是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"no platform data for lcd\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> <span style="COLOR: #0000cc">-</span>EINVAL<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获得在内核中定义的FrameBuffer平台设备的LCD配置信息结构体数据*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;display <span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays <span style="COLOR: #0000cc">+</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>default_display<span style="COLOR: #0000cc">;</span></font></span></code></p>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><font face="宋体"><span style="COLOR: #ff9900">&nbsp;&nbsp;&nbsp; /*给fb_info分配空间，大小为my2440fb_var结构的内存，framebuffer_alloc定义在fb.h中在fbsysfs.c中实现*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo <span style="COLOR: #0000cc">=</span> framebuffer_alloc<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">sizeof</span><span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> my2440fb_var<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">!</span>fbinfo<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"framebuffer alloc of registers failed\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">-</span><font color="#0000cc">ENOMEM</font><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">goto</span> err_noirq<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;platform_set_drvdata<span style="COLOR: #0000cc">(</span>pdev<span style="COLOR: #0000cc">,</span> fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*重新将LCD平台设备数据设置为fbinfo，好在后面的一些函数中来使用*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*这里的用途其实就是将fb_info的成员par(注意是一个void类型的指针)指向这里的私有变量结构体fbvar，<br>&nbsp;&nbsp;&nbsp;&nbsp; 目的是到其他接口函数中再取出fb_info的成员par，从而能继续使用这里的私有变量*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*在系统定义的LCD平台设备资源中获取LCD中断号,platform_get_irq定义在platform_device.h中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_irq_no <span style="COLOR: #0000cc">=</span> platform_get_irq<span style="COLOR: #0000cc">(</span>pdev<span style="COLOR: #0000cc">,</span> 0<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_irq_no <span style="COLOR: #0000cc">&lt;</span> 0<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断获取中断号是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"no lcd irq for platform\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> <span style="COLOR: #0000cc">-</span>ENOENT<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获取LCD平台设备所使用的IO端口资源，注意这个IORESOURCE_MEM标志和LCD平台设备定义中的一致*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;res <span style="COLOR: #0000cc">=</span> platform_get_resource<span style="COLOR: #0000cc">(</span>pdev<span style="COLOR: #0000cc">,</span> IORESOURCE_MEM<span style="COLOR: #0000cc">,</span> 0<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>res <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断获取资源是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"failed to get memory region resource\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> <span style="COLOR: #0000cc">-</span>ENOENT<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*申请LCD IO端口所占用的IO空间(注意理解IO空间和内存空间的区别),request_mem_region定义在ioport.h中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_mem <span style="COLOR: #0000cc">=</span> request_mem_region<span style="COLOR: #0000cc">(</span>res<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>start<span style="COLOR: #0000cc">,</span> res<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>end <span style="COLOR: #0000cc">-</span> res<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>start <span style="COLOR: #0000cc">+</span> 1<span style="COLOR: #0000cc">,</span> pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>name<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_mem <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断申请IO空间是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"failed to reserve memory region\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> <span style="COLOR: #0000cc">-</span>ENOENT<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*将LCD的IO端口占用的这段IO空间映射到内存的虚拟地址，ioremap定义在io.h中<br>&nbsp;&nbsp;&nbsp;&nbsp; 注意：IO空间要映射后才能使用，以后对虚拟地址的操作就是对IO空间的操作*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">=</span> ioremap<span style="COLOR: #0000cc">(</span>res<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>start<span style="COLOR: #0000cc">,</span> res<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>end <span style="COLOR: #0000cc">-</span> res<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>start <span style="COLOR: #0000cc">+</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断映射虚拟地址是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"ioremap() of registers failed\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">-</span>EINVAL<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">goto</span> err_nomem<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*从平台时钟队列中获取LCD的时钟，这里为什么要取得这个时钟，从LCD屏的时序图上看，各种控制信号的延迟<br>&nbsp;&nbsp;&nbsp;&nbsp; 都跟LCD的时钟有关。系统的一些时钟定义在arch/arm/plat-s3c24xx/s3c2410-clock.c中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock <span style="COLOR: #0000cc">=</span> clk_get<span style="COLOR: #0000cc">(</span><span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"lcd"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">!</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断获取时钟是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"failed to find lcd clock source\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">-</span>ENOENT<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">goto</span> err_nomap<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*时钟获取后要使能后才可以使用，clk_enable定义在arch/arm/plat-s3c/clock.c中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;clk_enable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*申请LCD中断服务，上面获取的中断号lcd_fb_irq，使用快速中断方式:IRQF_DISABLED<br>&nbsp;&nbsp;&nbsp;&nbsp; 中断服务程序为:lcd_fb_irq，将LCD平台设备pdev做参数传递过去了*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> request_irq<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_irq_no<span style="COLOR: #0000cc">,</span> lcd_fb_irq<span style="COLOR: #0000cc">,</span> IRQF_DISABLED<span style="COLOR: #0000cc">,</span> pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>name<span style="COLOR: #0000cc">,</span> fbvar<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>ret<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断申请中断服务是否成功*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"IRQ%d error %d\n"</span><span style="COLOR: #0000cc">,</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_irq_no<span style="COLOR: #0000cc">,</span> ret<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">-</span>EBUSY<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">goto</span> err_noclk<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span></font></span></code><code><span style="COLOR: #000000"><br><font face="宋体">&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*好了，以上是对要使用的资源进行了获取和设置。下面就开始初始化填充fb_info结构体*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*首先初始化fb_info中代表LCD固定参数的结构体fb_fix_screeninfo*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*像素值与显示内存的映射关系有5种，定义在fb.h中。现在采用FB_TYPE_PACKED_PIXELS方式，在该方式下，<br>&nbsp;&nbsp;&nbsp;&nbsp;像素值与内存直接对应，比如在显示内存某单元写入一个"1"时，该单元对应的像素值也将是"1"，这使得应用层<br>&nbsp;&nbsp;&nbsp;&nbsp;把显示内存映射到用户空间变得非常方便。Linux中当LCD为TFT屏时，显示驱动管理显示内存就是基于这种方式*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000cc"><font color="#000000">strcpy</font>(<font color="#000000">fbinfo</font>-&gt;<font color="#000000">fix</font>.<font color="#000000">id</font>, <font color="#000000">driver</font>_<font color="#000000">name</font>)</font><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*字符串形式的标识符*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>type <span style="COLOR: #0000cc">=</span> FB_TYPE_PACKED_PIXELS<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>type_aux <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*以下这些根据fb_fix_screeninfo定义中的描述，当没有硬件是都设为0*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>xpanstep <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>ypanstep <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span><font color="#0000cc">ywrapstep</font><span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>accel <span style="COLOR: #0000cc">=</span> FB_ACCEL_NONE<span style="COLOR: #0000cc">;</span></font></span></code></p>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><span style="COLOR: #0000cc"><font face="宋体"><span style="COLOR: #ff9900">&nbsp;&nbsp;&nbsp; /*接着，再初始化fb_info中代表LCD可变参数的结构体fb_var_screeninfo*/</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">nonstd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> 0</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">activate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> FB_ACTIVATE_NOW</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">accel_flags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> 0</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">vmode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> FB_VMODE_NONINTERLACED</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">xres&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> display</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">xres</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">yres&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> display</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">yres</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">var</font><span style="COLOR: #0000cc">.</span><font color="#000000">bits_per_pixel&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> display</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">bpp</font><span style="COLOR: #0000cc">;</span></font></span></span></code></p>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><span style="COLOR: #0000cc"><span style="COLOR: #0000cc"><font face="宋体"><span style="COLOR: #ff9900">&nbsp;&nbsp;&nbsp; /*指定对底层硬件操作的函数指针, 因内容较多故其定义在第③步中再讲*/</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">fbops&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">=</span><font color="#000000"> </font><span style="COLOR: #0000cc">&amp;</span><font color="#000000">my2440fb_ops</font><span style="COLOR: #0000cc">;</span></font></span></span></span></code></p><code>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><span style="COLOR: #0000cc"><font face="宋体">&nbsp;&nbsp;&nbsp; <font color="#000000">fbinfo</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">flags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="COLOR: #0000cc">=</span><font color="#000000"> FBINFO_FLAG_DEFAULT</font><span style="COLOR: #0000cc">;</span></font></span></p>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><span style="COLOR: #0000cc"><font face="宋体">&nbsp;&nbsp;&nbsp; fbinfo-&gt;pseudo_palette&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = &amp;fbvar-&gt;pseudo_pal;</font></span></p>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><span style="COLOR: #0000cc"><font face="宋体"></font></span>&nbsp;</p></code>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><span style="COLOR: #0000cc"><font face="宋体"><span style="COLOR: #ff9900">&nbsp;&nbsp;&nbsp; /*初始化色调色板(颜色表)为空*/</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000ff">for</span><span style="COLOR: #0000cc">(</span><font color="#000000">i </font><span style="COLOR: #0000cc">=</span><font color="#000000"> 0</font><span style="COLOR: #0000cc">;</span><font color="#000000"> i </font><span style="COLOR: #0000cc">&lt;</span><font color="#000000"> 256</font><span style="COLOR: #0000cc">;</span><font color="#000000"> i</font><span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">)</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">{</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar</font><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span><font color="#000000">palette_buffer</font><span style="COLOR: #0000cc">[</span><font color="#000000">i</font><span style="COLOR: #0000cc">]</span><font color="#000000"> </font><span style="COLOR: #0000cc">=</span><font color="#000000"> PALETTE_BUFF_CLEAR</font><span style="COLOR: #0000cc">;</span><br><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="COLOR: #0000cc">}</span></font></span></span></code></p><code><span style="COLOR: #000000"><span style="COLOR: #0000cc"><span style="COLOR: #0000cc"></span></span>
</span></code><p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><br><font face="宋体">&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">for</span> <span style="COLOR: #0000cc">(</span>i <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span> i <span style="COLOR: #0000cc">&lt;</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>num_displays<span style="COLOR: #0000cc">;</span> i<span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">)</span> <span style="COLOR: #ff9900">/*fb缓存的长度*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*计算FrameBuffer缓存的最大大小，这里右移3位(即除以8)是因为色位模式BPP是以位为单位*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> smem_len <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>xres <span style="COLOR: #0000cc">*</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>yres <span style="COLOR: #0000cc">*</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>bpp<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 3<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_len <span style="COLOR: #0000cc">&lt;</span> smem_len<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_len <span style="COLOR: #0000cc">=</span> smem_len<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*初始化LCD控制器之前要延迟一段时间*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;msleep<span style="COLOR: #0000cc">(</span>1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*初始化完fb_info后，开始对LCD各寄存器进行初始化，其定义在后面讲到*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_init_registers<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*初始化完寄存器后，开始检查fb_info中的可变参数，其定义在后面讲到*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_check_var<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*申请帧缓冲设备fb_info的显示缓冲区空间，其定义在后面讲到*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> my2440fb_map_video_memory<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>ret<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"failed to allocate video RAM: %d\n"</span><span style="COLOR: #0000cc">,</span> ret<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">-</span>ENOMEM<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">goto</span> err_nofb<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*最后，注册这个帧缓冲设备fb_info到系统中, register_framebuffer定义在fb.h中在fbmem.c中实现*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> register_framebuffer<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>ret <span style="COLOR: #0000cc">&lt;</span> 0<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"failed to register framebuffer device: %d\n"</span><span style="COLOR: #0000cc">,</span> ret<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">goto</span> err_video_nomem<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*对设备文件系统的支持(对设备文件系统的理解请参阅：嵌入式Linux之我行――设备文件系统剖析与使用)<br>&nbsp;&nbsp;&nbsp;&nbsp; 创建frambuffer设备文件，device_create_file定义在linux/device.h中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;ret <span style="COLOR: #0000cc">=</span> device_create_file<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>dev_attr_debug<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>ret<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">&amp;</span>pdev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"failed to add debug attribute\n"</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><br><span style="COLOR: #ff9900">/*以下是上面错误处理的跳转点*/</span><br>err_nomem<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;release_resource<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_mem<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;kfree<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_mem<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>err_nomap<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;iounmap<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>err_noclk<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;clk_disable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;clk_put<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>err_noirq<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;free_irq<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_irq_no<span style="COLOR: #0000cc">,</span> fbvar<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>err_nofb<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;platform_set_drvdata<span style="COLOR: #0000cc">(</span>pdev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;framebuffer_release<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>err_video_nomem<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_unmap_video_memory<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> ret<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*LCD中断服务程序*/</span><br><span style="COLOR: #0000ff">static</span> irqreturn_t lcd_fb_irq<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">int</span> irq<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">void</span> <span style="COLOR: #0000cc">*</span>dev_id<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> dev_id<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>lcd_irq_base<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> lcdirq<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*LCD中断挂起寄存器基地址*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;lcd_irq_base <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">+</span> S3C2410_LCDINTBASE<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*读取LCD中断挂起寄存器的值*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;lcdirq <span style="COLOR: #0000cc">=</span> readl<span style="COLOR: #0000cc">(</span>lcd_irq_base <span style="COLOR: #0000cc">+</span> S3C24XX_LCDINTPND<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断是否为中断挂起状态*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span><span style="COLOR: #0000cc">(</span>lcdirq <span style="COLOR: #0000cc">&amp;</span> S3C2410_LCDINT_FRSYNC<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*填充调色板*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_ready<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_write_palette<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置帧已插入中断请求*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>S3C2410_LCDINT_FRSYNC<span style="COLOR: #0000cc">,</span> lcd_irq_base <span style="COLOR: #0000cc">+</span> S3C24XX_LCDINTPND<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>S3C2410_LCDINT_FRSYNC<span style="COLOR: #0000cc">,</span> lcd_irq_base <span style="COLOR: #0000cc">+</span> S3C24XX_LCDSRCPND<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> IRQ_HANDLED<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*填充调色板*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> my2440fb_write_palette<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> my2440fb_var <span style="COLOR: #0000cc">*</span>fbvar<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> i<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>regs <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_ready <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">for</span> <span style="COLOR: #0000cc">(</span>i <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span> i <span style="COLOR: #0000cc">&lt;</span> 256<span style="COLOR: #0000cc">;</span> i<span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> ent <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_buffer<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>ent <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> PALETTE_BUFF_CLEAR<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">continue</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>ent<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_TFTPAL<span style="COLOR: #0000cc">(</span>i<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>readw<span style="COLOR: #0000cc">(</span>regs <span style="COLOR: #0000cc">+</span> S3C2410_TFTPAL<span style="COLOR: #0000cc">(</span>i<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> ent<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_buffer<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span> <span style="COLOR: #0000cc">=</span> PALETTE_BUFF_CLEAR<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_ready <span style="COLOR: #0000cc">=</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*LCD各寄存器进行初始化*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> my2440fb_init_registers<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> flags<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>tpal<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>lpcsel<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*从lcd_fb_probe探测函数设置的私有变量结构体中再获得LCD相关信息的数据*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_mach_info <span style="COLOR: #0000cc">*</span>mach_info <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>platform_data<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*获得临时调色板寄存器基地址，S3C2410_TPAL宏定义在mach-s3c2410/include/mach/regs-lcd.h中。<br>&nbsp;&nbsp;&nbsp;&nbsp;注意对于lpcsel这是一个针对三星TFT屏的一个专用寄存器，如果用的不是三星的TFT屏应该不用管它。*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;tpal <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">+</span> S3C2410_TPAL<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;lpcsel <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">+</span> S3C2410_LPCSEL<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*在修改下面寄存器值之前先屏蔽中断，将中断状态保存到flags中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_save<span style="COLOR: #0000cc">(</span>flags<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*这里就是在上一篇章中讲到的把IO端口C和D配置成LCD模式*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;modify_gpio<span style="COLOR: #0000cc">(</span>S3C2410_GPCUP<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpcup<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpcup_mask<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;modify_gpio<span style="COLOR: #0000cc">(</span>S3C2410_GPCCON<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpccon<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpccon_mask<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;modify_gpio<span style="COLOR: #0000cc">(</span>S3C2410_GPDUP<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpdup<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpdup_mask<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;modify_gpio<span style="COLOR: #0000cc">(</span>S3C2410_GPDCON<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpdcon<span style="COLOR: #0000cc">,</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>gpdcon_mask<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*恢复被屏蔽的中断*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="COLOR: #0000cc">(</span>flags<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>0x00<span style="COLOR: #0000cc">,</span> tpal<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*临时调色板寄存器使能禁止*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lpcsel<span style="COLOR: #0000cc">,</span> lpcsel<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*在上一篇中讲到过，它是三星TFT屏的一个寄存器，这里可以不管*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*该函数实现修改GPIO端口的值，注意第三个参数mask的作用是将要设置的寄存器值先清零*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">inline</span> <span style="COLOR: #0000ff">void</span> modify_gpio<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>reg<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> <span style="COLOR: #ff0000">set</span><span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> mask<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> tmp<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;tmp <span style="COLOR: #0000cc">=</span> readl<span style="COLOR: #0000cc">(</span>reg<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">&amp;</span> <span style="COLOR: #0000cc">~</span>mask<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>tmp <span style="COLOR: #0000cc">|</span> <span style="COLOR: #ff0000">set</span><span style="COLOR: #0000cc">,</span> reg<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*检查fb_info中的可变参数*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> my2440fb_check_var<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> i<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*从lcd_fb_probe探测函数设置的平台数据中再获得LCD相关信息的数据*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_var_screeninfo <span style="COLOR: #0000cc">*</span>var <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*fb_info中的可变参数*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*在lcd_fb_probe探测函数中设置的私有结构体数据*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_mach_info <span style="COLOR: #0000cc">*</span>mach_info <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>platform_data<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*LCD的配置结构体数据，这个配置结构体的赋值在上一篇章的"3. 帧缓冲设备作为平台设备"中*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_display <span style="COLOR: #0000cc">*</span>display <span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> s3c2410fb_display <span style="COLOR: #0000cc">*</span>default_display <span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays <span style="COLOR: #0000cc">+</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>default_display<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> type <span style="COLOR: #0000cc">=</span> default_display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>type<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*LCD的类型，看上一篇章的"3. 帧缓冲设备作为平台设备"中的type赋值是TFT类型*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*验证X/Y解析度*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> default_display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">&amp;</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> default_display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">&amp;</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> default_display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bpp<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display <span style="COLOR: #0000cc">=</span> default_display<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">for</span> <span style="COLOR: #0000cc">(</span>i <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span> i <span style="COLOR: #0000cc">&lt;</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>num_displays<span style="COLOR: #0000cc">;</span> i<span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>type <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>type <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>yres <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>xres <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays<span style="COLOR: #0000cc">[</span>i<span style="COLOR: #0000cc">]</span><span style="COLOR: #0000cc">.</span>bpp<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display <span style="COLOR: #0000cc">=</span> mach_info<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>displays <span style="COLOR: #0000cc">+</span> i<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">!</span>display<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> <span style="COLOR: #0000cc">-</span>EINVAL<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*配置LCD配置寄存器1中的5-6位(配置成TFT类型)和配置LCD配置寄存器5*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>type<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon5 <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/* 设置屏幕的虚拟解析像素和高度宽度 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres_virtual <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres_virtual <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>height <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>height<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>width <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>width<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/* 设置时钟像素，行、帧切换值，水平同步、垂直同步长度值 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>pixclock <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>pixclock<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>left_margin <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>left_margin<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>right_margin <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>right_margin<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>upper_margin <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>upper_margin<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lower_margin <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lower_margin<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>vsync_len <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>vsync_len<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>hsync_len <span style="COLOR: #0000cc">=</span> display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>hsync_len<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置透明度*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>transp<span style="COLOR: #0000cc">.</span>offset <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>transp<span style="COLOR: #0000cc">.</span>length <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*根据色位模式(BPP)来设置可变参数中R、G、B的颜色位域。对于这些参数值的设置请参考CPU数据<br>&nbsp;&nbsp;&nbsp;&nbsp;手册中"显示缓冲区与显示点对应关系图"，例如在上一篇章中我就画出了8BPP和16BPP时的对应关系图*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">switch</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 1<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 2<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 4<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 8<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/* 8 bpp 332 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>type <span style="COLOR: #0000cc">!</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 2<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 2<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><span style="COLOR: #0000ff">else</span><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 8<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 12<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/* 12 bpp 444 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 4<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 8<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 4<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 4<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 4<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 16<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/* 16 bpp */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>display<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5 <span style="COLOR: #0000cc">&amp;</span> S3C2410_LCDCON5_FRM565<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/* 565 format */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 11<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 6<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span> <span style="COLOR: #0000ff">else</span> <span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/* 5551 format */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 11<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 6<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 5<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 32<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/* 24 bpp 888 and 8 dummy */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 8<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>red<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> 16<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 8<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>green<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 8<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 8<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>blue<span style="COLOR: #0000cc">.</span>offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*申请帧缓冲设备fb_info的显示缓冲区空间*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> __init my2440fb_map_video_memory<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;dma_addr_t map_dma<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*用于保存DMA缓冲区总线地址*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*获得在lcd_fb_probe探测函数中设置的私有结构体数据*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> map_size <span style="COLOR: #0000cc">=</span> PAGE_ALIGN<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_len<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*获得FrameBuffer缓存的大小, PAGE_ALIGN定义在mm.h中*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*将分配的一个写合并DMA缓存区设置为LCD屏幕的虚拟地址(对于DMA请参考DMA相关知识)<br>&nbsp;&nbsp;&nbsp;&nbsp;dma_alloc_writecombine定义在arch/arm/mm/dma-mapping.c中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>screen_base <span style="COLOR: #0000cc">=</span> dma_alloc_writecombine<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> map_size<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>map_dma<span style="COLOR: #0000cc">,</span> GFP_KERNEL<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>screen_base<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置这片DMA缓存区的内容为空*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff0000">memset</span><span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>screen_base<span style="COLOR: #0000cc">,</span> 0x00<span style="COLOR: #0000cc">,</span> map_size<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*将DMA缓冲区总线地址设成fb_info不可变参数中framebuffer缓存的开始位置*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_start <span style="COLOR: #0000cc">=</span> map_dma<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>screen_base <span style="COLOR: #0000cc">?</span> 0 <span style="COLOR: #0000cc">:</span> <span style="COLOR: #0000cc">-</span>ENOMEM<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*释放帧缓冲设备fb_info的显示缓冲区空间*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">inline</span> <span style="COLOR: #0000ff">void</span> my2440fb_unmap_video_memory<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> map_size <span style="COLOR: #0000cc">=</span> PAGE_ALIGN<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_len<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*跟申请DMA的地方想对应*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;dma_free_writecombine<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> map_size<span style="COLOR: #0000cc">,</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>screen_base<span style="COLOR: #0000cc">,</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_start<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><br></font><font face="宋体"><span style="COLOR: #ff9900">/*LCD FrameBuffer设备移除的实现，注意这里使用一个__devexit宏，和lcd_fb_probe接口函数相对应。<br>&nbsp;&nbsp;在Linux内核中，使用了大量不同的宏来标记具有不同作用的函数和数据结构，这些宏在include/linux/init.h <br>&nbsp;&nbsp;头文件中定义，编译器通过这些宏可以把代码优化放到合适的内存位置，以减少内存占用和提高内核效率。<br>&nbsp;&nbsp;__devinit、__devexit就是这些宏之一，在probe()和remove()函数中应该使用__devinit和__devexit宏。<br>&nbsp;&nbsp;又当remove()函数使用了__devexit宏时，则在驱动结构体中一定要使用__devexit_p宏来引用remove()，<br>&nbsp;&nbsp;所以在第①步中就用__devexit_p来引用lcd_fb_remove接口函数。*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> __devexit lcd_fb_remove<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> platform_device <span style="COLOR: #0000cc">*</span>pdev<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo <span style="COLOR: #0000cc">=</span> platform_get_drvdata<span style="COLOR: #0000cc">(</span>pdev<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*从系统中注销帧缓冲设备*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;unregister_framebuffer<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*停止LCD控制器的工作*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_lcd_enable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">,</span> 0<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*延迟一段时间，因为停止LCD控制器需要一点时间 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;msleep<span style="COLOR: #0000cc">(</span>1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*释放帧缓冲设备fb_info的显示缓冲区空间*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_unmap_video_memory<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*将LCD平台数据清空和释放fb_info空间资源*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;platform_set_drvdata<span style="COLOR: #0000cc">(</span>pdev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;framebuffer_release<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*释放中断资源*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;free_irq<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_irq_no<span style="COLOR: #0000cc">,</span> fbvar<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*释放时钟资源*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(fbvar</span><span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;lcd_clock</span><span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clk_disable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clk_put<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock <span style="COLOR: #0000cc">=</span> <span style="COLOR: #ff0000">NULL</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*释放LCD IO空间映射的虚拟内存空间*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;iounmap<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*释放申请的LCD IO端口所占用的IO空间*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;release_resource<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_mem<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;kfree<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_mem<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*停止LCD控制器的工作*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> my2440fb_lcd_enable<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> my2440fb_var <span style="COLOR: #0000cc">*</span>fbvar<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">int</span> enable<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> flags<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*在修改下面寄存器值之前先屏蔽中断，将中断状态保存到flags中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_save<span style="COLOR: #0000cc">(</span>flags<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>enable<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_ENVID<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">~</span>S3C2410_LCDCON1_ENVID<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1<span style="COLOR: #0000cc">,</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*恢复被屏蔽的中断*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="COLOR: #0000cc">(</span>flags<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*对LCD FrameBuffer平台设备驱动电源管理的支持,CONFIG_PM这个宏定义在内核中*/</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">ifdef</span> CONFIG_PM<br><span style="COLOR: #ff9900">/*当配置内核时选上电源管理，则平台设备的驱动就支持挂起和恢复功能*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> lcd_fb_suspend<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> platform_device <span style="COLOR: #0000cc">*</span>pdev<span style="COLOR: #0000cc">,</span> pm_message_t state<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*挂起LCD设备，注意这里挂起LCD时并没有保存LCD控制器的各种状态，所以在恢复后LCD不会继续显示挂起前的内容<br>&nbsp;&nbsp;&nbsp;&nbsp; 若要继续显示挂起前的内容，则要在这里保存LCD控制器的各种状态，这里就不讲这个了，以后讲到电源管理再讲*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo <span style="COLOR: #0000cc">=</span> platform_get_drvdata<span style="COLOR: #0000cc">(p</span>dev<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*停止LCD控制器的工作*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_lcd_enable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">,</span> 0<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;msleep<span style="COLOR: #0000cc">(</span>1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*停止时钟*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;clk_disable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #0000ff">static</span>&nbsp;<font color="#0000ff">int</font> lcd_fb_resume<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> platform_device <span style="COLOR: #0000cc">*</span>pdev<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*恢复挂起的LCD设备*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo <span style="COLOR: #0000cc">=</span> platform_get_drvdata<span style="COLOR: #0000cc">(p</span>dev<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*开启时钟*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;clk_enable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*初始化LCD控制器之前要延迟一段时间*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;msleep<span style="COLOR: #0000cc">(</span>1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*恢复时重新初始化LCD各寄存器*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_init_registers<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*重新激活fb_info中所有的参数配置，该函数定义在第③步中再讲*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_activate_var<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;</font><font face="宋体"><span style="COLOR: #ff9900">/*正与挂起时讲到的那样，因为没保存挂起时LCD控制器的各种状态，<br>&nbsp;&nbsp;&nbsp;&nbsp;所以恢复后就让LCD显示空白，该函数定义也在第③步中再讲*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_blank<span style="COLOR: #0000cc">(</span>FB_BLANK_UNBLANK<span style="COLOR: #0000cc">,</span> fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #0000ff">else</span><br><span style="COLOR: #ff9900">/*如果配置内核时没选上电源管理,则平台设备的驱动就不支持挂起和恢复功能,这两个函数也就无需实现了*/</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">define</span> lcd_fb_suspend&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff0000">NULL</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">define</span> lcd_fb_resume&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff0000">NULL</span><br><span style="COLOR: #0000cc">#</span><span style="COLOR: #ff0000">endif</span></font></code></p></td></tr></tbody></table><br>
<div><span style="FONT-SIZE: 10.5pt; FONT-FAMILY: 宋体; mso-bidi-font-size: 11.0pt; mso-ascii-theme-font: minor-fareast; mso-fareast-theme-font: minor-fareast; mso-hansi-theme-font: minor-fareast; mso-bidi-font-family: &#39;Times New Roman&#39;; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA"><font size="2"><strong>③、帧缓冲设备驱动对底层硬件操作的函数接口实现(即：my2440fb_ops的实现)：</strong></font></span><br></div>
<div>
<table style="BORDER-COLLAPSE: collapse" bordercolor="#999999" cellspacing="0" cellpadding="0" width="95%" bgcolor="#f1f1f1" border="1">
<tbody>
<tr>
<td>
<p style="MARGIN: 5px; LINE-HEIGHT: 150%"><code><span style="COLOR: #000000"><span style="COLOR: #ff9900">/*Framebuffer底层硬件操作各接口函数*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">struct</span> fb_ops my2440fb_ops <span style="COLOR: #0000cc">=</span> <br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>owner&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> THIS_MODULE<span style="COLOR: #0000cc">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_check_var&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> my2440fb_check_var<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*第②步中已实现*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_set_par&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> my2440fb_set_par<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*设置fb_info中的参数，主要是LCD的显示模式*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_blank&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> my2440fb_blank<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*显示空白(即：LCD开关控制)*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_setcolreg&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> my2440fb_setcolreg<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*设置颜色表*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*以下三个函数是可选的，主要是提供fb_console的支持，在内核中已经实现，这里直接调用即可*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_fillrect&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> cfb_fillrect<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*定义在drivers/video/cfbfillrect.c中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_copyarea&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> cfb_copyarea<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*定义在drivers/video/cfbcopyarea.c中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">.</span>fb_imageblit&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">=</span> cfb_imageblit<span style="COLOR: #0000cc">,</span><span style="COLOR: #ff9900">/*定义在drivers/video/cfbimgblt.c中*/</span><br><span style="COLOR: #0000cc">};</span><br><br><span style="COLOR: #ff9900">/*设置fb_info中的参数，这里根据用户设置的可变参数var调整固定参数fix*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> my2440fb_set_par<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获得fb_info中的可变参数*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_var_screeninfo <span style="COLOR: #0000cc">*</span>var <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断可变参数中的色位模式，根据色位模式来设置色彩模式*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">switch</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 32<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 16<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 12<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*12BPP时，设置为真彩色(分成红、绿、蓝三基色)*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>visual <span style="COLOR: #0000cc">=</span> FB_VISUAL_TRUECOLOR<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 1<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*1BPP时，设置为黑白色(分黑、白两种色，FB_VISUAL_MONO01代表黑，FB_VISUAL_MONO10代表白)*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>visual <span style="COLOR: #0000cc">=</span> FB_VISUAL_MONO01<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">default</span><span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*默认设置为伪彩色，采用索引颜色显示*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>visual <span style="COLOR: #0000cc">=</span> FB_VISUAL_PSEUDOCOLOR<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置fb_info中固定参数中一行的字节数，公式：1行字节数=(1行像素个数*每像素位数BPP)/8 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>line_length <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres_virtual <span style="COLOR: #0000cc">*</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">/</span> 8<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*修改以上参数后，重新激活fb_info中的参数配置(即：使修改后的参数在硬件上生效)*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_activate_var<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*重新激活fb_info中的参数配置*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> my2440fb_activate_var<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获得结构体变量*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>regs <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获得fb_info可变参数*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> fb_var_screeninfo <span style="COLOR: #0000cc">*</span>var <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*计算LCD控制寄存器1中的CLKVAL值, 根据数据手册中该寄存器的描述，计算公式如下：<br>&nbsp;&nbsp;&nbsp;&nbsp;* STN屏：VCLK = HCLK / (CLKVAL * 2), CLKVAL要求&gt;= 2<br>&nbsp;&nbsp;&nbsp;&nbsp;* TFT屏：VCLK = HCLK / [(CLKVAL + 1) * 2], CLKVAL要求&gt;= 0*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> clkdiv <span style="COLOR: #0000cc">=</span> my2440fb_calc_pixclk<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">,</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>pixclock<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">/</span> 2<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获得屏幕的类型*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> type <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">&amp;</span> S3C2410_LCDCON1_TFT<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>type <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*根据数据手册按照TFT屏的要求配置LCD控制寄存器1-5*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_config_tft_lcd_regs<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">-</span>clkdiv<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>clkdiv <span style="COLOR: #0000cc">&lt;</span> 0<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clkdiv <span style="COLOR: #0000cc">=</span> 0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">else</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*根据数据手册按照STN屏的要求配置LCD控制寄存器1-5*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_config_stn_lcd_regs<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>clkdiv <span style="COLOR: #0000cc">&lt;</span> 2<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clkdiv <span style="COLOR: #0000cc">=</span> 2<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置计算的LCD控制寄存器1中的CLKVAL值*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_CLKVAL<span style="COLOR: #0000cc">(</span>clkdiv<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*将各参数值写入LCD控制寄存器1-5中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">&amp;</span> <span style="COLOR: #0000cc">~</span>S3C2410_LCDCON1_ENVID<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon2<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON2<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon3<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON3<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon4<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON4<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon5<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON5<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*配置帧缓冲起始地址寄存器1-3*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_set_lcdaddr<span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_ENVID<span style="COLOR: #0000cc">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>regs<span style="COLOR: #0000cc">.</span>lcdcon1<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDCON1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*计算LCD控制寄存器1中的CLKVAL值*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> my2440fb_calc_pixclk<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> my2440fb_var <span style="COLOR: #0000cc">*</span>fbvar<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> pixclk<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*获得LCD的时钟*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> clk <span style="COLOR: #0000cc">=</span> clk_get_rate<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_clock<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/* 像素时钟单位是皮秒，而时钟的单位是赫兹，所以计算公式为：<br>&nbsp;&nbsp;&nbsp;&nbsp; * Hz -&gt; picoseconds is / 10^-12<br>&nbsp;&nbsp;&nbsp;&nbsp; */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> <span style="COLOR: #0000ff">long</span> <span style="COLOR: #ff0000">div</span> <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> <span style="COLOR: #0000ff">long</span><span style="COLOR: #0000cc">)</span>clk <span style="COLOR: #0000cc">*</span> pixclk<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff0000">div</span> <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">=</span> 12<span style="COLOR: #0000cc">;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/* div / 2^12 */</span><br>&nbsp;&nbsp;&nbsp;&nbsp;do_div<span style="COLOR: #0000cc">(</span><span style="COLOR: #ff0000">div</span><span style="COLOR: #0000cc">,</span> 625 <span style="COLOR: #0000cc">*</span> 625UL <span style="COLOR: #0000cc">*</span> 625<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span> <span style="COLOR: #ff9900">/* div / 5^12, do_div宏定义在asm/div64.h中*/</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> <span style="COLOR: #ff0000">div</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*根据数据手册按照TFT屏的要求配置LCD控制寄存器1-5*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> my2440fb_config_tft_lcd_regs<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">const</span> <span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">struct</span> s3c2410fb_hw <span style="COLOR: #0000cc">*</span>regs<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">const</span> <span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">const</span> <span style="COLOR: #0000ff">struct</span> fb_var_screeninfo <span style="COLOR: #0000cc">*</span>var <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*根据色位模式设置LCD控制寄存器1和5，参考数据手册*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">switch</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 1<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*1BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT1BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 2<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*2BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT2BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 4<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*4BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT4BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 8<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*8BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT8BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON5_BSWP <span style="COLOR: #0000cc">|</span> S3C2410_LCDCON5_FRM565<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5 <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">~</span>S3C2410_LCDCON5_HWSWP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 16<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*16BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT16BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5 <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">~</span>S3C2410_LCDCON5_BSWP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON5_HWSWP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 32<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*32BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_TFT24BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon5 <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">~</span><span style="COLOR: #0000cc">(</span>S3C2410_LCDCON5_BSWP <span style="COLOR: #0000cc">|</span> S3C2410_LCDCON5_HWSWP <span style="COLOR: #0000cc">|</span> S3C2410_LCDCON5_BPP24BL<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">default</span><span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*无效的BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"invalid bpp %d\n"</span><span style="COLOR: #0000cc">,</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置LCD配置寄存器2、3、4*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon2 <span style="COLOR: #0000cc">=</span> S3C2410_LCDCON2_LINEVAL<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON2_VBPD<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>upper_margin <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON2_VFPD<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lower_margin <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON2_VSPW<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>vsync_len <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon3 <span style="COLOR: #0000cc">=</span> S3C2410_LCDCON3_HBPD<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>right_margin <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON3_HFPD<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>left_margin <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON3_HOZVAL<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon4 <span style="COLOR: #0000cc">=</span> S3C2410_LCDCON4_HSPW<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>hsync_len <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*根据数据手册按照STN屏的要求配置LCD控制寄存器1-5*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> my2440fb_config_stn_lcd_regs<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">const</span> <span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">struct</span> s3c2410fb_hw <span style="COLOR: #0000cc">*</span>regs<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">const</span> <span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">const</span> <span style="COLOR: #0000ff">struct</span> fb_var_screeninfo <span style="COLOR: #0000cc">*</span>var <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> type <span style="COLOR: #0000cc">=</span> regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">&amp;</span> <span style="COLOR: #0000cc">~</span>S3C2410_LCDCON1_TFT<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">int</span> hs <span style="COLOR: #0000cc">=</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>xres <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 2<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> wdly <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>left_margin <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 4<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> wlh <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>hsync_len <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 4<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>type <span style="COLOR: #0000cc">!</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_STN4<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">=</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*根据色位模式设置LCD控制寄存器1，参考数据手册*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">switch</span> <span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 1<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*1BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_STN1BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 2<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*2BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_STN2GREY<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 4<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*4BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_STN4GREY<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 8<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*8BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_STN8BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs <span style="COLOR: #0000cc">*</span><span style="COLOR: #0000cc">=</span> 3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> 12<span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*12BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon1 <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> S3C2410_LCDCON1_STN12BPP<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hs <span style="COLOR: #0000cc">*</span><span style="COLOR: #0000cc">=</span> 3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">default</span><span style="COLOR: #0000cc">:</span><span style="COLOR: #ff9900">/*无效的BPP*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dev_err<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>dev<span style="COLOR: #0000cc">,</span> <span style="COLOR: #ff00ff">"invalid bpp %d\n"</span><span style="COLOR: #0000cc">,</span> var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>bits_per_pixel<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*设置LCD配置寄存器2、3、4, 参考数据手册*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>wdly <span style="COLOR: #0000cc">&gt;</span> 3<span style="COLOR: #0000cc">)</span> wdly <span style="COLOR: #0000cc">=</span> 3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>wlh <span style="COLOR: #0000cc">&gt;</span> 3<span style="COLOR: #0000cc">)</span> wlh <span style="COLOR: #0000cc">=</span> 3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon2 <span style="COLOR: #0000cc">=</span> S3C2410_LCDCON2_LINEVAL<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>yres <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon3 <span style="COLOR: #0000cc">=</span>&nbsp;S3C2410_LCDCON3_WDLY<span style="COLOR: #0000cc">(</span>wdly<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON3_LINEBLANK<span style="COLOR: #0000cc">(</span>var<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>right_margin <span style="COLOR: #0000cc">/</span> 8<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S3C2410_LCDCON3_HOZVAL<span style="COLOR: #0000cc">(</span>hs <span style="COLOR: #0000cc">-</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;regs<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcdcon4 <span style="COLOR: #0000cc">=</span> S3C2410_LCDCON4_WLH<span style="COLOR: #0000cc">(</span>wlh<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*配置帧缓冲起始地址寄存器1-3，参考数据手册*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> my2440fb_set_lcdaddr<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> saddr1<span style="COLOR: #0000cc">,</span> saddr2<span style="COLOR: #0000cc">,</span> saddr3<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>regs <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;saddr1 <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_start <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;saddr2 <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>smem_start<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;saddr2 <span style="COLOR: #0000cc">+</span><span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>line_length <span style="COLOR: #0000cc">*</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">.</span>yres<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;saddr2 <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">=</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;saddr3 <span style="COLOR: #0000cc">=</span> S3C2410_OFFSIZE<span style="COLOR: #0000cc">(</span>0<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">|</span> S3C2410_PAGEWIDTH<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>line_length <span style="COLOR: #0000cc">/</span> 2<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">&amp;</span> 0x3ff<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>saddr1<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDSADDR1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>saddr2<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDSADDR2<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>saddr3<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_LCDSADDR3<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*显示空白，blank mode有5种模式，定义在fb.h中，是一个枚举*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> my2440fb_blank<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">int</span> blank_mode<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>regs <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*根据显示空白的模式来设置LCD是开启还是停止*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>blank_mode <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> FB_BLANK_POWERDOWN<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_lcd_enable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">,</span> 0<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*在第②步中定义*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">else</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my2440fb_lcd_enable<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">,</span> 1<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><span style="COLOR: #ff9900">/*在第②步中定义*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*根据显示空白的模式来控制临时调色板寄存器*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>blank_mode <span style="COLOR: #0000cc">=</span><span style="COLOR: #0000cc">=</span> FB_BLANK_UNBLANK<span style="COLOR: #0000cc">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*临时调色板寄存器无效*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>0x0<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_TPAL<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">else</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*临时调色板寄存器有效*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>S3C2410_TPAL_EN<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_TPAL<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*设置颜色表*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">int</span> my2440fb_setcolreg<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">unsigned</span> regno<span style="COLOR: #0000cc">,</span><span style="COLOR: #0000ff">unsigned</span> red<span style="COLOR: #0000cc">,</span><span style="COLOR: #0000ff">unsigned</span> green<span style="COLOR: #0000cc">,</span><span style="COLOR: #0000ff">unsigned</span> blue<span style="COLOR: #0000cc">,</span><span style="COLOR: #0000ff">unsigned</span> transp<span style="COLOR: #0000cc">,</span><span style="COLOR: #0000ff">struct</span> fb_info <span style="COLOR: #0000cc">*</span>fbinfo<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> val<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;<span style="COLOR: #0000cc">*</span>fbvar <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>par<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>regs <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">switch</span> <span style="COLOR: #0000cc">(</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>fix<span style="COLOR: #0000cc">.</span>visual<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> FB_VISUAL_TRUECOLOR<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*真彩色*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>regno <span style="COLOR: #0000cc">&lt;</span> 16<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u32 <span style="COLOR: #0000cc">*</span>pal <span style="COLOR: #0000cc">=</span> fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>pseudo_palette<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val <span style="COLOR: #0000cc">=</span> chan_to_field<span style="COLOR: #0000cc">(</span>red<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">.</span>red<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> chan_to_field<span style="COLOR: #0000cc">(</span>green<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">.</span>green<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> chan_to_field<span style="COLOR: #0000cc">(</span>blue<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000cc">&amp;</span>fbinfo<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>var<span style="COLOR: #0000cc">.</span>blue<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pal<span style="COLOR: #0000cc">[</span>regno<span style="COLOR: #0000cc">]</span> <span style="COLOR: #0000cc">=</span> val<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">case</span> FB_VISUAL_PSEUDOCOLOR<span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*伪彩色*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span>regno <span style="COLOR: #0000cc">&lt;</span> 256<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val <span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>red <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 0<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">&amp;</span> 0xf800<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>green <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 5<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">&amp;</span> 0x07e0<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val <span style="COLOR: #0000cc">|</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">(</span>blue <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span> 11<span style="COLOR: #0000cc">)</span> <span style="COLOR: #0000cc">&amp;</span> 0x001f<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>val<span style="COLOR: #0000cc">,</span> regs <span style="COLOR: #0000cc">+</span> S3C2410_TFTPAL<span style="COLOR: #0000cc">(</span>regno<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*修改调色板*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;schedule_palette_update<span style="COLOR: #0000cc">(</span>fbvar<span style="COLOR: #0000cc">,</span> regno<span style="COLOR: #0000cc">,</span> val<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">break</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">default</span><span style="COLOR: #0000cc">:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 1<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> 0<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">inline</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> chan_to_field<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> chan<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">struct</span> fb_bitfield <span style="COLOR: #0000cc">*</span>bf<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;chan <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">=</span> 0xffff<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;chan <span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">&gt;</span><span style="COLOR: #0000cc">=</span> 16 <span style="COLOR: #0000cc">-</span> bf<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>length<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">return</span> chan <span style="COLOR: #0000cc">&lt;</span><span style="COLOR: #0000cc">&lt;</span> bf<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>offset<span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span><br><br><span style="COLOR: #ff9900">/*修改调色板*/</span><br><span style="COLOR: #0000ff">static</span> <span style="COLOR: #0000ff">void</span> schedule_palette_update<span style="COLOR: #0000cc">(</span><span style="COLOR: #0000ff">struct</span> my2440fb_var&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">*</span>fbvar<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> regno<span style="COLOR: #0000cc">,</span> <span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">int</span> val<span style="COLOR: #0000cc">)</span><br><span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> flags<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">unsigned</span> <span style="COLOR: #0000ff">long</span> irqen<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*LCD中断挂起寄存器基地址*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">void</span> __iomem <span style="COLOR: #0000cc">*</span>lcd_irq_base <span style="COLOR: #0000cc">=</span> fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>lcd_base <span style="COLOR: #0000cc">+</span> S3C2410_LCDINTBASE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*在修改中断寄存器值之前先屏蔽中断，将中断状态保存到flags中*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_save<span style="COLOR: #0000cc">(</span>flags<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_buffer<span style="COLOR: #0000cc">[</span>regno<span style="COLOR: #0000cc">]</span> <span style="COLOR: #0000cc">=</span> val<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*判断调色板是否准备就像*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000ff">if</span> <span style="COLOR: #0000cc">(</span><span style="COLOR: #0000cc">!</span>fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_ready<span style="COLOR: #0000cc">)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fbvar<span style="COLOR: #0000cc">-</span><span style="COLOR: #0000cc">&gt;</span>palette_ready <span style="COLOR: #0000cc">=</span> 1<span style="COLOR: #0000cc">;</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*使能中断屏蔽寄存器*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;irqen <span style="COLOR: #0000cc">=</span> readl<span style="COLOR: #0000cc">(</span>lcd_irq_base <span style="COLOR: #0000cc">+</span> S3C24XX_LCDINTMSK<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;irqen <span style="COLOR: #0000cc">&amp;</span><span style="COLOR: #0000cc">=</span> <span style="COLOR: #0000cc">~</span>S3C2410_LCDINT_FRSYNC<span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writel<span style="COLOR: #0000cc">(</span>irqen<span style="COLOR: #0000cc">,</span> lcd_irq_base <span style="COLOR: #0000cc">+</span> S3C24XX_LCDINTMSK<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #0000cc">}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR: #ff9900">/*恢复被屏蔽的中断*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;local_irq_restore<span style="COLOR: #0000cc">(</span>flags<span style="COLOR: #0000cc">)</span><span style="COLOR: #0000cc">;</span><br><span style="COLOR: #0000cc">}</span></span></code></p></td></tr></tbody></table></div>
<div>&nbsp;</div>
<div><br></div>
<div></div>
<div><strong><font face="宋体" size="3">五、从整体上再描述一下FrameBuffer设备驱动实例代码的结构：</font></strong></div>
<div><strong><font face="宋体" size="3"></font></strong>&nbsp;</div>
<div><strong><font face="宋体" size="2">1、在第①部分代码中主要做的事情有：</font></strong></div>
<div><font face="宋体"><font size="2">&nbsp;&nbsp; a.将LCD设备注册到系统平台设备中；</font></font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; b.定义LCD平台设备结构体lcd_fb_driver。</font></div>
<div><strong><font face="宋体" size="2"></font></strong>&nbsp;</div>
<div><strong><font face="宋体" size="2">2、在第②部分代码中主要做的事情有：</font></strong></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; a.获取和设置LCD平台设备的各种资源；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; b.分配fb_info结构体空间；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; c.初始化fb_info结构体中的各参数；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; d.初始化LCD控制器；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; e.检查fb_info中可变参数；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; f.申请帧缓冲设备的显示缓冲区空间；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; g.注册fb_info。</font></div>
<div><strong><font face="宋体" size="2"></font></strong>&nbsp;</div>
<div><strong><font face="宋体" size="2">3、在第<span style="FONT-SIZE: 10.5pt; FONT-FAMILY: 宋体; mso-bidi-font-size: 11.0pt; mso-ascii-theme-font: minor-fareast; mso-fareast-theme-font: minor-fareast; mso-hansi-theme-font: minor-fareast; mso-bidi-font-family: &#39;Times New Roman&#39;; mso-bidi-theme-font: minor-bidi; mso-ansi-language: EN-US; mso-fareast-language: ZH-CN; mso-bidi-language: AR-SA"><font size="2"><strong>③</strong></font></span>部分代码中主要做的事情有：</font></strong></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; a.实现对fb_info相关参数进行检查的硬件接口函数；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; b.实现对LCD显示模式进行设定的硬件接口函数；</font></div>
<div><font face="宋体" size="2">&nbsp;&nbsp; c.实现对LCD显示开关(空白)的硬件接口函数等。</font></div>
<div><font face="宋体" size="2"></font>&nbsp;</div>
<div><strong><font face="宋体" size="2"></font></strong>&nbsp;</div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div><p></p></div>
</div>
<div class="cont5">
<div class="t">我的更多文章</div>
<ul>
<li><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=2305655">博客已升级，请注意变更地址</a>  (2011-07-29 16:41:44)</li>
<li><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786959">Linux poll机制分析</a>  (2011-07-05 16:06:21)</li>
<li><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786958">嵌入式Linux之我行--内核I2C子系统详解</a>  (2011-05-13 11:44:57)</li>
<li><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786957">Linux内核的cpufreq(变频)机制</a>  (2011-05-12 16:23:24)</li>
<li><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786956">最近更新</a>  (2010-11-22 15:54:40)</li>
<li><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786955">嵌入式Linux之我行――u-boot-2009.08在2440上的移植详解（六）</a>  (2010-11-16 16:45:33)</li>
	
</ul>
</div>

<div class="cont6">
<!-- 分享 -->
<div class="fx">
<div class="icon">										 
<!-- JiaThis Button BEGIN -->
<div id="ckepop">
<a href="http://blog.chinaunix.net/link.php?url=http://www.jiathis.com%2Fshare%2F" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank">分享到：</a>
<a class="jiathis_button_tsina" title="分享到新浪微博"><span class="jiathis_txt jiathis_separator jtico jtico_tsina">新浪微博</span></a>
<a class="jiathis_button_qzone" title="分享到QQ空间"><span class="jiathis_txt jiathis_separator jtico jtico_qzone">QQ空间</span></a>
<a class="jiathis_button_kaixin001" title="分享到开心网"><span class="jiathis_txt jiathis_separator jtico jtico_kaixin001">开心网</span></a>
<a class="jiathis_button_douban" title="分享到豆瓣"><span class="jiathis_txt jiathis_separator jtico jtico_douban">豆瓣</span></a>
<a class="jiathis_button_renren" title="分享到人人网"><span class="jiathis_txt jiathis_separator jtico jtico_renren">人人网</span></a>
<a class="jiathis_button_twitter" title="分享到Twitter"><span class="jiathis_txt jiathis_separator jtico jtico_twitter">twitter</span></a>
<a class="jiathis_button_fb" title="分享到Facebook"><span class="jiathis_txt jiathis_separator jtico jtico_fb">fb</span></a>
</div>
<script type="text/javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->
</div>

<span style="cursor:pointer;">
<a id="support">0</a>
<br>
<a onclick="ajaxmenu(event, this.id,0, 2000, &#39;doSupport&#39;)" id="click_blogid_1786943" href="http://blog.chinaunix.net/cp.php?ac=click&op=add&clickid=4&idtype=blogid&id=1786943&hash=a15ba3b3510008fc0db506165dbc028d">
&nbsp;&nbsp;&nbsp;<b>顶</b>
</a>
</span>
<div class="clear"></div>
</div>



<!-- 阅读 -->

<div class="read">
<a href="javascript:;">阅读<b>(5411)</b></a>┊ <a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786943#comment">评论 <b>(<span id="comm_num">2</span>)</b></a>┊<a href="http://blog.chinaunix.net/cp.php?ac=favorites&op=addfavorites&blogid=1786943" id="a_favorite" onclick="ajaxmenu(event, this.id, 1)">收藏(0)</a>┊<a href="http://blog.chinaunix.net/cp.php?ac=common&op=report&idtype=blogid&id=1786943" id="a_report" onclick="ajaxmenu(event, this.id, 1)">举报</a>┊<a href="javascript:window.print();">打印</a>
</div>

<div class="next1">前一篇：<a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786942">嵌入式Linux之我行――S3C2440上LCD驱动(FrameBuffer)实例开发讲解（一）</a></div>

<!-- 评论 -->
<div class="tit8" id="comment_dv">
<span><a href="http://blog.chinaunix.net/space.php?uid=22174347&do=blog&id=1786943#comment">[发评论]</a></span>
<b>评论</b>&nbsp;重要提示：警惕虚假中奖信息!
</div>
<div id="comment" class="comments_list">
<div class="box_content">
<ul class="post_list a_list justify_list" id="comment_ul">
<li id="comment_213885_li" class="space cont7 "><div class="avatar48"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/hidden.gif" class="avatar"></div>
<div class="title">
chinaunix网友
<span class="gray">2010-07-19 23:25</span>

</div>

<div class="detail" id="comment_213885">小弟正在学嵌入式，面对着一大堆不知所云的裸机代码狂汗，狂晕。在看了博主的文章之后，如醍醐灌顶，豁然开朗，小弟实在是佩服的五体投地！！！</div>

</li><li id="comment_213912_li" class=" cont7 "><div class="avatar48"><img src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/hidden.gif" class="avatar"></div>
<div class="title">
chinaunix网友
<span class="gray">2010-06-22 01:37</span>

</div>

<div class="detail" id="comment_213912">还有比这更详细的吗！！ 支持！</div>

</li></ul>
</div>
</div>
<div class="clear"></div>

<!-- 发评论 -->
<div class="logins">亲，您还没有登录,请<a href="http://blog.chinaunix.net/do.php?ac=819edd0a745efc58097086a9ef2fc155">[登录]</a>或<a href="http://blog.chinaunix.net/do.php?ac=8f442ba1e0c79cd3efcd1fd42b8aad8e">[注册]</a>后再进行评论</div>
</div>
</div>
</div>

<div class="clear"></div>
</div>
<script type="text/javascript">
<!--
var blogid = 1786943;
var bloguid = 0;
function doSupport(){
var x = new Ajax();
x.get('do.php?ac=ajax&op=support&id='+blogid , function(s){
document.getElementById('support').innerHTML = s;
});
}

function checkComment(id){

//	if(bloguid < 1 &&  ($('nim').checked == false) ){
//		alert('请选择匿名发表评论！');
//		return false;
//	}
if(trim($('seccode').value) == ''){
alert('验证码不能为空！');
return false;
}
s('comment_dv');
ajaxpost('quickcommentform_'+id, 'comment_add');
$('seccode').value = '';
var img = 'do.php?ac=seccode&rand='+Math.random();
$('img_seccode').src = img;
}
$('font_14').style.fontWeight='bold';
function doZoom(s){
$('font_12').style.fontWeight='normal';
$('font_14').style.fontWeight='normal';
$('font_16').style.fontWeight='normal';
$('font_'+s).style.fontWeight='bold';
s = s + 'px';
$('detail').style.fontSize = s;
}
//-->
</script>
<div id="footer">
<div class="l">
<a href="http://blog.chinaunix.net/link.php?url=http://www.chinaunix.net%2Fabout%2Findex.shtml">关于我们</a> | 
<a href="http://blog.chinaunix.net/link.php?url=http://www.it168.com%2Fbottomfile%2Fit168.shtml">关于IT168</a> | 
<a href="http://blog.chinaunix.net/link.php?url=http://www.chinaunix.net%2Fabout%2Fconnect.html">联系方式</a> | 
<a href="http://blog.chinaunix.net/link.php?url=http://www.chinaunix.net%2Fabout%2Fservice.html">广告合作</a> | 
<a href="http://blog.chinaunix.net/link.php?url=http://blog.chinaunix.net%2Fabout%2Ffl.html">法律声明</a> | 
<a href="http://blog.chinaunix.net/link.php?url=http://blog.chinaunix.net%2Fregister.php">免费注册</a> 
<address>
Copyright &#169; 2001-2010 ChinaUnix.net All Rights Reserved 北京皓辰网域网络信息技术有限公司. 版权所有 
</address>
</div>
<div class="r">
感谢所有关心和支持过ChinaUnix的朋友们<br>京ICP证041476号 京ICP证060528号
</div>
<div class="clear"></div>
</div>
<div id="dialogBoxShadow" style="display:none;z-index:49;"></div>
<input id="dot" value="" type="hidden">
<script type="text/javascript">
<!--
if($('dot').value == 'theme')  getPageSet();
function checkHtitle(){
var tt = $('spacetitle').value;
if(ttlen(trim(tt)) > 48){
alert('博客宣言不能超过48个字符！');
return false;
}
ajaxpost('home_from','homeTitle');
}
function checkBbrief(){
var tt = $('blog_brief').value;
if(ttlen(trim(tt)) > 200){
alert('个性签名不能超过200个字符！');
return false;
}
ajaxpost('brief_form','blogBrief');
}
function homeTitle()
{
var spacetitle_value = $('spacetitle').value;
if(!spacetitle_value){
spacetitle_value = '还没有博客宣言';
}
var x = new Ajax();
x.get('/do.php?ac=ajax&op=htl', function(s){
document.getElementById('home_t').innerHTML = s
});
s('home_title');
h('home_title_form');
}
function blogBrief()
{
var spacetitle_value = $('blog_brief').value;
if(!spacetitle_value){
spacetitle_value = '还没有个性签名';
}
var x = new Ajax();
x.get('/do.php?ac=ajax&op=bbf', function(s){
document.getElementById('blog_b').innerHTML = s
});
s('blog_brief');
h('blog_brief_form');
}
//-->
</script>
<script language="javascript" src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/pv.js"></script>
<script type="text/javascript">
    function sendPV(){
        var pvTrack = new PvTrack();
        pvTrack.type = 35; // 频道类别ID
        pvTrack.channel = 189; // 频道ID
        pvTrack.pageType = 0;
        pvTrack.track();
    }
    window.setTimeout("sendPV()", 0); 

</script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20237423-2']);
  _gaq.push(['_setDomainName', '.chinaunix.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<div style="display:none">
<script type="text/javascript"> 
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F0ee5e8cdc4d43389b3d1bfd76e83216b' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./hbhuanggang - ChinaUnix博客 - IT人与你分享快乐生活(二)_files/h.js" type="text/javascript"></script>
</div>

 

</body></html>